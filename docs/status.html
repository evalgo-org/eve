<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Status | EVE</title>
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="stylesheet" href="/assets/css/status.css">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <h1>EVE</h1>
                <span class="version">v0.0.62</span>
            </div>
            <ul class="nav-links">
                <li><a href="/">Home</a></li>
                <li><a href="/services.html">Services</a></li>
                <li><a href="/architecture.html">Architecture</a></li>
                <li><a href="/getting-started.html">Getting Started</a></li>
                <li><a href="/status.html" class="active status-link">Status</a></li>
                <li><a href="https://github.com/evalgo-org/eve" target="_blank">GitHub</a></li>
            </ul>
        </div>
    </nav>

    <main class="container status-page">
        <div class="status-header">
            <h1>EVE System Status</h1>
            <p>Real-time health monitoring of all EVE microservices</p>
            <p class="status-note">Status updates every 5 seconds via WebSocket</p>
        </div>

        <div id="status-container" class="loading">
            <div class="spinner"></div>
            <p>Loading live status data...</p>
        </div>
    </main>

    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h4>EVE Platform</h4>
                    <ul>
                        <li><a href="/services.html">Services</a></li>
                        <li><a href="/architecture.html">Architecture</a></li>
                        <li><a href="/getting-started.html">Getting Started</a></li>
                        <li><a href="/status.html">System Status</a></li>
                    </ul>
                </div>

                <div class="footer-section">
                    <h4>Documentation</h4>
                    <ul>
                        <li><a href="https://pkg.go.dev/eve.evalgo.org">Go Packages</a></li>
                        <li><a href="https://github.com/evalgo-org/eve">GitHub</a></li>
                        <li><a href="https://github.com/evalgo-org/eve/issues">Issues</a></li>
                    </ul>
                </div>

                <div class="footer-section">
                    <h4>Resources</h4>
                    <ul>
                        <li><a href="https://schema.org">Schema.org</a></li>
                        <li><a href="https://opentelemetry.io">OpenTelemetry</a></li>
                        <li><a href="https://prometheus.io">Prometheus</a></li>
                    </ul>
                </div>
            </div>

            <div class="footer-bottom">
                <p>&copy; 2025 evalgo.org | Built with semantic microservices</p>
            </div>
        </div>
    </footer>

    <script>
        // Status page configuration
        const STATUS_API_URL = 'http://localhost:8110/v1/api/status';
        const WS_URL = 'ws://localhost:8110/ws';

        let ws = null;
        let reconnectInterval = null;

        // Fetch and render status
        function fetchStatus() {
            fetch(STATUS_API_URL)
                .then(response => response.json())
                .then(data => {
                    renderStatus(data);
                    connectWebSocket();
                })
                .catch(error => {
                    console.error('Failed to fetch status:', error);
                    renderError();
                });
        }

        // Connect WebSocket for live updates
        function connectWebSocket() {
            ws = new WebSocket(WS_URL);

            ws.onopen = () => {
                console.log('WebSocket connected');
                if (reconnectInterval) {
                    clearInterval(reconnectInterval);
                    reconnectInterval = null;
                }
            };

            ws.onmessage = (event) => {
                const message = JSON.parse(event.data);
                if (message.type === 'initial' || message.type === 'update') {
                    renderStatus(message.data);
                }
            };

            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
            };

            ws.onclose = () => {
                console.log('WebSocket disconnected, attempting to reconnect...');
                if (!reconnectInterval) {
                    reconnectInterval = setInterval(() => {
                        connectWebSocket();
                    }, 5000);
                }
            };
        }

        // Render status data
        function renderStatus(data) {
            const container = document.getElementById('status-container');
            container.className = 'status-content';

            if (!data || data.total_services === 0) {
                container.innerHTML = `
                    <div class="status-empty">
                        <h2>Initializing...</h2>
                        <p>Waiting for health check data. This may take up to 30 seconds.</p>
                    </div>
                `;
                return;
            }

            const services = data.services || [];
            const serviceItems = services.map(service => {
                const uptimeHtml = service.uptime_stats ? `
                    <div class="uptime-badges">
                        <span class="uptime-badge">24h: ${(service.uptime_stats.uptime_24h || 0).toFixed(2)}%</span>
                        <span class="uptime-badge">7d: ${(service.uptime_stats.uptime_7d || 0).toFixed(2)}%</span>
                        <span class="uptime-badge">30d: ${(service.uptime_stats.uptime_30d || 0).toFixed(2)}%</span>
                    </div>
                ` : '';

                return `
                    <div class="service-status-item">
                        <div class="service-details">
                            <div class="service-name">${service.service_name || service.service_id}</div>
                            ${uptimeHtml}
                        </div>
                        <div class="service-info">
                            <div class="service-metrics">
                                <div class="metric">
                                    <span class="metric-icon">âš¡</span>
                                    <span>${service.response_time_ms ? service.response_time_ms.toFixed(0) : '0'}ms</span>
                                </div>
                                <div class="metric">
                                    <span class="metric-icon">ðŸ“Š</span>
                                    <span>${service.error_rate ? (service.error_rate * 100).toFixed(1) : '0'}% errors</span>
                                </div>
                            </div>
                            <span class="status-badge ${service.status}">${service.status}</span>
                        </div>
                    </div>
                `;
            }).join('');

            const statusText = data.overall_status === 'operational' ? 'âœ“ All Systems Operational' :
                              data.overall_status === 'degraded' ? 'âš  Degraded Performance' :
                              'âœ— System Outage';

            container.innerHTML = `
                <div class="overall-status">
                    <h2>Overall System Status</h2>
                    <div class="status-badge-large ${data.overall_status}">${statusText}</div>
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number">${data.total_services}</div>
                            <div class="stat-label">Total Services</div>
                        </div>
                        <div class="stat-card operational">
                            <div class="stat-number">${data.operational}</div>
                            <div class="stat-label">Operational</div>
                        </div>
                        <div class="stat-card degraded">
                            <div class="stat-number">${data.degraded}</div>
                            <div class="stat-label">Degraded</div>
                        </div>
                        <div class="stat-card outage">
                            <div class="stat-number">${data.outage}</div>
                            <div class="stat-label">Outage</div>
                        </div>
                    </div>
                </div>
                <div class="services-status">
                    <h2>Service Details</h2>
                    ${serviceItems}
                </div>
            `;
        }

        // Render error state
        function renderError() {
            const container = document.getElementById('status-container');
            container.className = 'status-error';
            container.innerHTML = `
                <div class="error-message">
                    <h2>Failed to Load Status</h2>
                    <p>Could not connect to status service at ${STATUS_API_URL}</p>
                    <p>Retrying in 5 seconds...</p>
                </div>
            `;
            setTimeout(fetchStatus, 5000);
        }

        // Keep WebSocket alive
        setInterval(() => {
            if (ws && ws.readyState === WebSocket.OPEN) {
                ws.send(JSON.stringify({type: 'ping'}));
            }
        }, 30000);

        // Initialize
        fetchStatus();
    </script>
</body>
</html>
