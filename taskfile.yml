version: '3'

vars:
  COVERAGE_FILE: coverage.out
  COVERAGE_HTML: coverage.html
  COVERAGE_TXT: coverage.txt
  SECURITY_REPORT: security-report.txt
  MIN_COVERAGE: 60

tasks:
  default:
    desc: Show available tasks
    cmds:
      - task --list
    silent: true

  # Testing tasks
  test:
    desc: Run all unit tests (no integration)
    cmds:
      - echo "Running unit tests..."
      - go test -v -race ./...

  test:quick:
    desc: Run tests without race detection (faster)
    cmds:
      - go test ./...

  test:integration:
    desc: Run integration tests (requires containers)
    cmds:
      - echo "Running integration tests..."
      - echo "Make sure test containers are running - task containers up"
      - go test -v -race -tags=integration ./...

  test:integration:local:
    desc: Run integration tests with taskfile-managed containers
    deps: [containers:up, containers:wait]
    cmds:
      - echo "Running integration tests against local containers..."
      - |
        export POSTGRES_URL="host=localhost port=5433 user=testuser password=testpass dbname=testdb sslmode=disable"
        export COUCHDB_URL="http://admin:testpass@localhost:5985"
        export RABBITMQ_URL="amqp://guest:guest@localhost:5673/"
        go test -v -race -tags=integration ./...

  test:all:
    desc: Run all tests (unit + integration)
    deps: [test, test:integration:local]
    cmds:
      - echo "✓ All tests passed!"

  coverage:
    desc: Run unit tests with coverage report
    cmds:
      - echo "Running unit tests with coverage..."
      - go test -v -race -coverprofile={{.COVERAGE_FILE}} -covermode=atomic ./...
      - echo "\nCoverage Summary:"
      - go tool cover -func={{.COVERAGE_FILE}} | grep total

  coverage:integration:
    desc: Run all tests (unit + integration) with coverage
    deps: [containers:up, containers:wait]
    cmds:
      - echo "Running all tests with coverage..."
      - |
        export POSTGRES_URL="host=localhost port=5433 user=testuser password=testpass dbname=testdb sslmode=disable"
        export COUCHDB_URL="http://admin:testpass@localhost:5985"
        export RABBITMQ_URL="amqp://guest:guest@localhost:5673/"
        go test -v -race -tags=integration -coverprofile={{.COVERAGE_FILE}} -covermode=atomic ./...
      - echo "\nCoverage Summary:"
      - go tool cover -func={{.COVERAGE_FILE}} | grep total

  coverage:html:
    desc: Generate HTML coverage report and open in browser
    deps: [coverage]
    cmds:
      - echo "Generating HTML coverage report..."
      - go tool cover -html={{.COVERAGE_FILE}} -o {{.COVERAGE_HTML}}
      - echo "Opening coverage report in browser..."
      - cmd: xdg-open {{.COVERAGE_HTML}}
        platforms: [linux]
        ignore_error: true
      - cmd: open {{.COVERAGE_HTML}}
        platforms: [darwin]
        ignore_error: true
      - cmd: start {{.COVERAGE_HTML}}
        platforms: [windows]
        ignore_error: true

  coverage:by-package:
    desc: Show test coverage by package
    deps: [coverage]
    cmds:
      - echo "\nCoverage by package:"
      - go tool cover -func={{.COVERAGE_FILE}} | grep -v "total:" | awk '{print $1, $3}' | column -t

  coverage:check:
    desc: Check coverage meets minimum threshold (60%)
    deps: [coverage]
    cmds:
      - |
        COVERAGE=$(go tool cover -func={{.COVERAGE_FILE}} | grep total | awk '{print $3}' | sed 's/%//')
        echo "Total coverage: ${COVERAGE}%"
        if [ "$(echo "$COVERAGE < {{.MIN_COVERAGE}}" | bc)" -eq 1 ]; then
          echo "❌ Coverage below {{.MIN_COVERAGE}}% threshold"
          exit 1
        else
          echo "✓ Coverage meets {{.MIN_COVERAGE}}% threshold"
        fi

  # Benchmarking tasks
  benchmark:
    desc: Run benchmark tests
    cmds:
      - echo "Running benchmarks..."
      - go test -bench=. -benchmem -run=^$$ ./...

  benchmark:compare:
    desc: Run benchmarks and save results for comparison
    cmds:
      - echo "Running benchmarks and saving results..."
      - go test -bench=. -benchmem -run=^$$ ./... | tee benchmark-new.txt
      - echo "Results saved to benchmark-new.txt"

  # Code quality tasks
  check:
    desc: Run code formatting and vetting
    cmds:
      - go fmt ./...
      - go vet ./...

  check:hack:
    desc: Run code checks excluding vendor directory
    cmds:
      - go fmt $(go list ./... | grep -v /vendor/)
      - go vet $(go list ./... | grep -v /vendor/)

  lint:
    desc: Run golangci-lint
    cmds:
      - echo "Running golangci-lint..."
      - |
        if ! command -v golangci-lint &> /dev/null; then
          echo "golangci-lint not installed. Install from: https://golangci-lint.run/usage/install/"
          exit 1
        fi
      - golangci-lint run --timeout=5m ./...

  lint:fix:
    desc: Run golangci-lint with auto-fix
    cmds:
      - golangci-lint run --fix --timeout=5m ./...

  # Security tasks
  security:
    desc: Run gosec security scanner
    cmds:
      - echo "Running gosec security scanner..."
      - |
        if ! command -v gosec &> /dev/null; then
          echo "gosec not installed. Run: go install github.com/securego/gosec/v2/cmd/gosec@latest"
          exit 1
        fi
      - gosec -fmt=text -out={{.SECURITY_REPORT}} ./...
      - cat {{.SECURITY_REPORT}}

  security:json:
    desc: Run security scan with JSON output
    cmds:
      - gosec -fmt=json -out=security-report.json ./...
      - cat security-report.json

  # Build tasks
  build:
    desc: Build the project
    cmds:
      - echo "Building..."
      - go build -v ./...

  build:all:
    desc: Build for multiple platforms
    cmds:
      - echo "Building for multiple platforms..."
      - GOOS=linux GOARCH=amd64 go build -o bin/eve-linux-amd64 ./...
      - GOOS=darwin GOARCH=amd64 go build -o bin/eve-darwin-amd64 ./...
      - GOOS=windows GOARCH=amd64 go build -o bin/eve-windows-amd64.exe ./...
      - echo "Binaries created in bin/"

  # Cleanup tasks
  clean:
    desc: Clean build artifacts and coverage reports
    cmds:
      - echo "Cleaning build artifacts..."
      - rm -f {{.COVERAGE_FILE}} {{.COVERAGE_HTML}} {{.COVERAGE_TXT}} {{.SECURITY_REPORT}}
      - rm -f security-report.json benchmark-new.txt benchmark-old.txt
      - rm -rf bin/
      - go clean -testcache
      - echo "Clean complete"

  clean:all:
    desc: Deep clean including mod cache
    deps: [clean]
    cmds:
      - go clean -modcache
      - go clean -cache

  # Dependency management
  deps:
    desc: Download and verify dependencies
    cmds:
      - echo "Downloading dependencies..."
      - go mod download
      - go mod verify
      - echo "✓ Dependencies downloaded and verified"

  deps:tidy:
    desc: Tidy and verify dependencies
    cmds:
      - go mod tidy
      - go mod verify

  deps:update:
    desc: Update all dependencies
    cmds:
      - go get -u ./...
      - go mod tidy

  # Development tools
  install-tools:
    desc: Install development tools
    cmds:
      - echo "Installing development tools..."
      - go install github.com/golangci/golangci-lint/cmd/golangci-lint@latest
      - go install github.com/securego/gosec/v2/cmd/gosec@latest
      - go install golang.org/x/tools/cmd/goimports@latest
      - go install github.com/go-task/task/v3/cmd/task@latest
      - echo "✓ Development tools installed"

  # Watch mode (requires entr or watchexec)
  watch:
    desc: Run tests in watch mode
    cmds:
      - |
        if command -v watchexec &> /dev/null; then
          watchexec -e go -c task test
        elif command -v entr &> /dev/null; then
          find . -name '*.go' | entr -c task test
        else
          echo "Please install watchexec or entr for watch mode"
          echo "  brew install watchexec (macOS)"
          echo "  apt-get install entr (Linux)"
          exit 1
        fi

  # All checks (CI simulation)
  ci:
    desc: Run all CI checks locally
    cmds:
      - task: test
      - task: coverage
      - task: lint
      - task: security
      - echo "\n✓ All CI checks passed!"

  all:
    desc: Run all checks (test, coverage, lint)
    cmds:
      - task: test
      - task: coverage
      - task: lint
      - echo "\n✓ All checks passed!"

  # Documentation
  docs:
    desc: Generate and view documentation
    cmds:
      - echo "Starting godoc server at http://localhost:6060"
      - echo "Press Ctrl+C to stop"
      - godoc -http=:6060

  docs:coverage:
    desc: Generate coverage documentation
    deps: [coverage]
    cmds:
      - |
        echo "# Coverage Report" > {{.COVERAGE_TXT}}
        echo "" >> {{.COVERAGE_TXT}}
        echo "Generated: $(date)" >> {{.COVERAGE_TXT}}
        echo "" >> {{.COVERAGE_TXT}}
        go tool cover -func={{.COVERAGE_FILE}} >> {{.COVERAGE_TXT}}
        cat {{.COVERAGE_TXT}}

  # Container management for integration tests
  containers:network:
    desc: Create Docker network for test containers
    cmds:
      - docker network create eve-test-network 2>/dev/null || true
    silent: true

  containers:postgres:
    desc: Start PostgreSQL test container
    deps: [containers:network]
    cmds:
      - |
        docker run -d \
          --name eve-postgres-test \
          --network eve-test-network \
          -e POSTGRES_USER=testuser \
          -e POSTGRES_PASSWORD=testpass \
          -e POSTGRES_DB=testdb \
          -p 5433:5432 \
          -v eve-postgres-test-data:/var/lib/postgresql/data \
          --health-cmd="pg_isready -U testuser -d testdb" \
          --health-interval=5s \
          --health-timeout=5s \
          --health-retries=5 \
          postgres:16-alpine 2>/dev/null || echo "PostgreSQL container already running"

  containers:couchdb:
    desc: Start CouchDB test container
    deps: [containers:network]
    cmds:
      - |
        docker run -d \
          --name eve-couchdb-test \
          --network eve-test-network \
          -e COUCHDB_USER=admin \
          -e COUCHDB_PASSWORD=testpass \
          -p 5985:5984 \
          -v eve-couchdb-test-data:/opt/couchdb/data \
          --health-cmd="curl -f http://localhost:5984/_up || exit 1" \
          --health-interval=5s \
          --health-timeout=5s \
          --health-retries=5 \
          couchdb:3.3 2>/dev/null || echo "CouchDB container already running"

  containers:rabbitmq:
    desc: Start RabbitMQ test container
    deps: [containers:network]
    cmds:
      - |
        docker run -d \
          --name eve-rabbitmq-test \
          --network eve-test-network \
          -e RABBITMQ_DEFAULT_USER=guest \
          -e RABBITMQ_DEFAULT_PASS=guest \
          -p 5673:5672 \
          -p 15673:15672 \
          -v eve-rabbitmq-test-data:/var/lib/rabbitmq \
          --health-cmd="rabbitmq-diagnostics -q ping" \
          --health-interval=5s \
          --health-timeout=5s \
          --health-retries=5 \
          rabbitmq:3.13-management-alpine 2>/dev/null || echo "RabbitMQ container already running"

  containers:up:
    desc: Start all test containers (PostgreSQL, CouchDB, RabbitMQ)
    deps: [containers:postgres, containers:couchdb, containers:rabbitmq]
    cmds:
      - echo "✓ Test containers started"
      - echo "  PostgreSQL - localhost:5433 (user testuser, pass testpass, db testdb)"
      - echo "  CouchDB - http://localhost:5985 (user admin, pass testpass)"
      - echo "  RabbitMQ - amqp://localhost:5673 (user guest, pass guest)"
      - echo "  RabbitMQ Management UI - http://localhost:15673"

  containers:down:
    desc: Stop and remove test containers
    cmds:
      - echo "Stopping test containers..."
      - docker stop eve-postgres-test eve-couchdb-test eve-rabbitmq-test 2>/dev/null || true
      - docker rm eve-postgres-test eve-couchdb-test eve-rabbitmq-test 2>/dev/null || true
      - echo "✓ Test containers stopped"

  containers:restart:
    desc: Restart test containers
    cmds:
      - task: containers:down
      - task: containers:up

  containers:logs:
    desc: Show logs from test containers
    cmds:
      - echo "=== PostgreSQL Logs ==="
      - docker logs eve-postgres-test --tail 50 2>/dev/null || echo "PostgreSQL not running"
      - echo ""
      - echo "=== CouchDB Logs ==="
      - docker logs eve-couchdb-test --tail 50 2>/dev/null || echo "CouchDB not running"
      - echo ""
      - echo "=== RabbitMQ Logs ==="
      - docker logs eve-rabbitmq-test --tail 50 2>/dev/null || echo "RabbitMQ not running"

  containers:logs:follow:
    desc: Follow logs from all test containers
    cmds:
      - echo "Following logs (Ctrl+C to stop)..."
      - |
        docker logs -f eve-postgres-test 2>/dev/null &
        docker logs -f eve-couchdb-test 2>/dev/null &
        docker logs -f eve-rabbitmq-test 2>/dev/null &
        wait

  containers:clean:
    desc: Stop containers and remove volumes (clean slate)
    cmds:
      - echo "Stopping containers and removing volumes..."
      - docker stop eve-postgres-test eve-couchdb-test eve-rabbitmq-test 2>/dev/null || true
      - docker rm eve-postgres-test eve-couchdb-test eve-rabbitmq-test 2>/dev/null || true
      - docker volume rm eve-postgres-test-data eve-couchdb-test-data eve-rabbitmq-test-data 2>/dev/null || true
      - docker network rm eve-test-network 2>/dev/null || true
      - echo "✓ Test containers, volumes, and network removed"

  containers:status:
    desc: Show status of test containers
    cmds:
      - echo "Container Status:"
      - docker ps -a --filter "name=eve-postgres-test" --filter "name=eve-couchdb-test" --filter "name=eve-rabbitmq-test" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"

  containers:wait:
    desc: Wait for test containers to be healthy
    cmds:
      - echo "Waiting for containers to be healthy..."
      - |
        # Wait for PostgreSQL
        echo -n "Waiting for PostgreSQL..."
        until docker exec eve-postgres-test pg_isready -U testuser -d testdb 2>/dev/null; do
          echo -n "."
          sleep 1
        done
        echo " ready!"

        # Wait for CouchDB
        echo -n "Waiting for CouchDB..."
        until curl -sf http://localhost:5985/_up > /dev/null 2>&1; do
          echo -n "."
          sleep 1
        done
        echo " ready!"

        # Wait for RabbitMQ
        echo -n "Waiting for RabbitMQ..."
        until docker exec eve-rabbitmq-test rabbitmq-diagnostics -q ping 2>/dev/null; do
          echo -n "."
          sleep 1
        done
        echo " ready!"

        echo "✓ All containers are healthy and ready!"

  # Git hooks
  hooks:install:
    desc: Install git pre-commit hooks
    cmds:
      - |
        cat > .git/hooks/pre-commit << 'EOF'
        #!/bin/sh
        echo "Running pre-commit checks..."
        task check test
        EOF
      - chmod +x .git/hooks/pre-commit
      - echo "✓ Git pre-commit hook installed"

  hooks:uninstall:
    desc: Uninstall git pre-commit hooks
    cmds:
      - rm -f .git/hooks/pre-commit
      - echo "✓ Git pre-commit hook removed"
